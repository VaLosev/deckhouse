---
title: Обновление Kubernetes в Deckhouse Kubernetes Platform
permalink: ru/update/kubernetes/update-kubernetes/
lang: ru
---

## Изменение версии Kubernetes на узлах кластера

<!--Обновление идет:
Вначале обновляются  узлы кластера, затем компоненты управляющего слоя: ноды, IP сервер, контро плэй менеджер, скедулер. Нужны команды, которые позволят это всё отследить.-->
Обновление patch-версии компонентов управляющего слоя (cotrol plane) в рамках минорной версии происходит автоматически вместе с обновлением версии Deckhouse Kubernetes Platform (DKP). Нельзя управлять обновлением patch-версий. Если `kubelet` на всех узлах версии 1.30 и все компоненты управляющего слоя версии 1.30, то обновление произойдет на следующую версию 1.31 — и так далее, пока версия не будет той, что указана в конфигурации.

Каждый узел в кластере принадлежит к одной из групп узлов. Как только `node-manager` определяет, что версия управляющего слоя на всех узлах обновилась, то он приступает к обновлению версии `kubelet`. Если обновление узла не приводит к простою, оно считается безопасным и выполняется в автоматическом режиме. В данном случае обновление `kubelet` больше не приводит к перезапуску контейнеров.

Чтобы изменит версию Kubernetes, выполните следующие шаги:

1. Выполните команду:

   ```
   kubectl -n d8-system exec -ti deploy/deckhouse --deckhouse-controller edit cluster-configuration
   ```

1. Для автоматического выполнения выберите [автоматический режим](../../supported_versions.html#kubernetes).) обновления `kubernetesVersion: Automatic` в ресурсе *ClusterConfiguration* или укажите желаемую минорную версию управляющего слоя. Для [ручного режима](ссылка) измените параметр `kubernetesVersion` в ресурсе *ClusterConfiguration*. <!-- нужна команда--> Если указанная для обновления версия Kubernetes в параметре `kubernetesVersion` не соответствует текущей версии управляющего слоя в кластере, Deckhouse Kubernetes Platform (DKP) для поддержания работы кластера начнет также обновлять компоненты:
      - **при переходе к новой версии** обновление происходит последовательными этапами, по одной минорной версии, например от 1.22 к 1.23, от 1.23 к 1.24, от 1.24 к 1.25. На каждом этапе сначала обновляется версия управляющего слоя, затем происходит обновление `kubelet` на узлах кластера.
      - **при переходе к предыдущей версии**  откат возможен только на одну версию назад от максимальной минорной версии управляющего слоя, когда-либо использовавшейся в кластере.

1. Чтобы подтвердить обновления в соответствующем кастомном ресурсе *DeckhouseRelease* установите поле `approved` в `true`. <!-- нужна эта команда-->

1. Сохраните изменения. <!--- с помощью чего - уточнить--> 
   > Во время обновления может быть кратковременная недоступность API-сервера.
1. Отслеживайте ход обновления с помощью команды `kubectl get no`. Когда в выводе команды у каждого узла кластера в колонке `VERSION` появится нужная версия, обновление можно считать завершенны.


   > Обновление управляющего слоя не влияет на работу приложений и может происходить без выделения окна для регламентных работ. оно выполняется безопасно и для кластера с одним мастером, и для мультимастерных кластеров.

1. Посмотрите режим обновления кластера в [конфигурации](modules/002-deckhouse/configuration.html) модуля `deckhouse`. Для этого выполните следующую команду:

   ```shell
   kubectl get mc deckhouse -oyaml
   ```

   Пример вывода:

   ```yaml
   apiVersion: deckhouse.io/v1alpha1
   kind: ModuleConfig
   metadata:
     creationTimestamp: "2022-12-14T11:13:03Z"
     generation: 1
     name: deckhouse
     resourceVersion: "3258626079"
     uid: c64a2532-af0d-496b-b4b7-eafb5d9a56ee
   spec:
     settings:
       releaseChannel: Stable
       update:
         windows:
         - days:
           - Mon
           from: "19:00"
           to: "20:00"
     version: 1
   status:
     state: Enabled
     status: ""
     type: Embedded
     version: "1"
   ```

1. Проверьте, что [настроен](#как-установить-желаемый-канал-обновлений) необходимый канал обновлений.
1. Проверьте корректность разрешения DNS-имени хранилища образов Deckhouse Kubernetes Platform.

1. Получите и сравните IP-адреса хранилища образов Deckhouse Kubernetes Platform (`registry.deckhouse.ru`) на одном из узлов и в поде Deckhouse Kubernetes Platform. Они должны совпадать.

Пример получения IP-адреса хранилища образов Deckhouse Kubernetes Platform на узле:

   ```shell
   $ getent ahosts registry.deckhouse.ru
   185.193.90.38    STREAM registry.deckhouse.ru
   185.193.90.38    DGRAM
   185.193.90.38    RAW
   ```

Пример получения IP-адреса хранилища образов Deckhouse Kubernetes Platform в поде Deckhouse Kubernetes Platform:
  
  ```shell
  $ kubectl -n d8-system exec -ti deploy/deckhouse -c deckhouse -- getent ahosts registry.deckhouse.ru
  185.193.90.38    STREAM registry.deckhouse.ru
  185.193.90.38    DGRAM  registry.deckhouse.ru
  ```
  
Если полученные IP-адреса не совпадают, проверьте настройки [DNS на узле](ссылка).