---
title: Обновление кластеров Kubernetes в Deckhouse Kubernetes Platform
permalink: ru/update/kubernetes/update-kubernetes/
lang: ru
---

Чтобы обновить версию Kubernetes в кластере измените параметр [kubernetesVersion](installing/configuration.html#clusterconfiguration-kubernetesversion) в структуре [ClusterConfiguration](installing/configuration.html#clusterconfiguration), выполнив следующие шаги:

1. Выполните команду:

   ```
   kubectl -n d8-system exec -ti deploy/deckhouse -- deckhouse-controller edit cluster-configuration
   ```

1. Измените параметр `kubernetesVersion`.
1. Сохраните изменения. Узлы кластера начнут последовательно обновляться. Если указанная для обновления версия с параметром [kubernetesVersion](../../installing/configuration.html#clusterconfiguration-kubernetesversion) не соответствует текущей версии control plane в кластере, запускается изменение версий компонентов:
Обновление в разных NodeGroup выполняется параллельно. Внутри каждой NogeGroup узлы обновляются последовательно, по одному.
- При upgrade:
  - Обновление происходит последовательными этапами, по одной минорной версии, например от 1.22 к 1.23, от 1.23 к 1.24, от 1.24 к 1.25.
  - На каждом этапе сначала обновляется версия `control plane`, затем происходит обновление `kubelet` на узлах кластера.  
- При downgrade:
  - Успешный downgrade гарантируется только на одну версию вниз от максимальной минорной версии `control plane`, когда-либо использовавшейся в кластере.
  - Происходит downgrade `kubelet` на узлах кластера.
  - Происходит downgrade компонентов `control plane`.
Текущая версия Kubernetes в кластере вычисляется на основании версии `control-plane` и узлов кластера.
1. Отслеживать ход обновления можно с помощью команды `kubectl get no`. Обновление можно считать завершенным, когда в выводе команды у каждого узла кластера в колонке `VERSION` появится обновленная версия.
1. Обновите минорную версию компонентов control plane с помощью параметра [kubernetesVersion](../../installing/configuration.html#clusterconfiguration-kubernetesversion), в котором можно выбрать [автоматический режим обновления (значение `Automatic`)](ссылка) или указать желаемую минорную версию control plane. Версию control plane, которая используется по умолчанию (при использовании `kubernetesVersion: Automatic`), а также список поддерживаемых версий Kubernetes можно найти в [документации](../../supported_versions.html#kubernetes).

Обновление patch-версии компонентов `control plane` в рамках минорной версии происходит автоматически вместе с обновлением версии Deckhouse Kubernetes Platform. Управлять обновлением patch-версий нельзя.

> Обновление `control plane` выполняется безопасно и для single-master, и для multi-master-кластеров. Во время обновления может быть кратковременная недоступность API-сервера. На работу приложений в кластере обновление не влияет и может выполняться без выделения окна для регламентных работ.

<!--Внутри подсистемы `candi` есть два модуля, которые отвечают за управление [control-plane](ссылка) и [управление узлами](ссылка). В сontrol-plane-manager автоматически отслеживаются изменения. вот это возможно убрать или пояснить-->

**Обновление control-plane будет происходит следующим образом:**

Например, если `kubelet` на всех узлах версии 1.27 и все `control-plane` компоненты версии 1.27, обновление произойдет на следующую версию 1.28 — и так далее, пока версия не будет той, что указана в конфигурации.

Также control-plane-manager следит, чтобы обновление компонентов `control-plane` выполнялось по очереди на каждом мастер-узле: для этого реализован алгоритм запроса и выдачи разрешения на обновление через специальный [диспетчер](ссылка).

Node-manager отвечает за управление узлами, в том числе и за обновление `kubelet`:

Каждый узел в кластере принадлежит к одной из NodeGroup. Как только node-manager определяет, что версия `control-plane` на всех узлах обновилась, то он приступает к обновлению версии kubelet. Если обновление узла не приводит к простою, оно считается безопасным и выполняется в автоматическом режиме. В данном случае обновление `kubelet` больше не приводит к перезапуску контейнеров.

В рамках node-manager также реализован механизм автоматической выдачи разрешений на обновление узла, что гарантирует одновременное обновление только одного узла в рамках NodeGroup. При этом обновление узлов в NodeGroup выполняется, только когда требуемое количество узлов равно текущему количеству узлов в состоянии `Ready`, то есть нет узлов в процессе заказа. (Это касается только облачных кластеров, где есть автоматический заказ новых виртуальных машин.)