Так ну что погнали Как вы знаете меня

зовут Дима сталеров Как уже сказали

Может быть вы знаете может быть вы

видели где-то меня и я технический

директор и основатель фланта

Ну собственно я вот начну необычно Если

вы хотите задать вопрос какой то мне

самый лучший способ это сделать это

написать мне в Twitter это вот прям

верняк я решил активно переключаться на

Twitter короче Пишите в Twitter Если вы

хотите спросить у фланта самый лучший

вариант это писать в группу в тележке

фланта там отвечают там ну мы там все

есть там Я отвечаю иногда

если вы хотите спросить что-то

по-английски мы недавно запустили для

иностранной аудитории комьюнити

фландском там больше про нашу утилиты

соответственно если вас вопрос

по-английски Вы работаете

англоязычные компании вам туда значит

Окей доклад сегодня называется Как

обновить cubernights и самый

самый классный самый простой вопрос

просто взять самый простой ответ просто

взять и обновить точно так же как с

собой там как нарисовать сову начать

рисовать сову нарисовать сову вот

глупо да но реально

если очень кратко отвечать на вопрос как

обновить cubernets ответ будет никакой

проблемы нету он хорошо обновляется его

нужно взять и обновить Но если вы там не

художник да то вот будет также как самый

[музыка]

Но несмотря на то что

как бы в кубе все продумано

значит если мы посмотрим в Twitter и

посмотрим что думает Twitter об

обновлении cubernet то есть вот такой

вопрос

опрос не вопрос А опрос типа

как вы обновляете куда едва вариант

ответа но они сводятся к двум первый

вариант мы обновляем по месту второй

вариант мы

создаем новый кластер рядом с новой

версией и переезжаем приложение туда

старые класть удаляем Ну и третий

вариант типа я бы хотел по месту Но

приходится через через второй кластер

если мы нижних два варианта про

суммируем там получится что больше

половины людей в целом обновляет кубы

через создание нового кластеры С точки

зрения это там боль печаль плохо потому

что в кубе все есть там все классно

обновляется у нас большой фланта большой

опыт обновления Куба без каких-либо

проблем

Но вот статистику не попали те люди

которые ответили Нет мы не обновляем

интернете ну то есть это из тех кто

обновляет вот как бы люди пополам

поделились А мне до конца неизвестно Мне

кажется больше половины людей вообще куб

не обновляют есть еще другой интересный

вопрос Типа вы авто обновляете cubernets

и там варианты ответа да только

патч релиза это 16 там 7 на 116 8

или

ипаче и минорам 16 на 117 или Ну вариант

ответа вы там типа сошли с ума и вариант

ответа

попкорн можете интерпретировать

Я думаю вы знаете как интерпретировать

попкорн данной ситуации по факту людей

из тех кто обновляет кубы людей которые

авто обновляют кубы

очень мало

10 процентов

если мы посмотрим анонс Куба 19

то мы увидим то что окно поддержки

был увеличено с 9 месяцев до года

поддержка подразумевается что версии

выпущены последние 9 месяцев активно

в них приходят активно фиксами портится

важные изменения

а ну и связано Это с тем что

действительно Ну как бы людям тяжело

обновляться Вот люди застревают

Окей вопрос почему так Ну и ответ опять

Мы ищем в Твиттере и в гифках Веселых

Господа я вот сейчас рассказываю тут

какое-то а вы экран-то мы видите Скажите

пожалуйста я сейчас понял то что я

наверное экран то хреново шарине

[смех]

провал Короче короче

Сейчас подождите Это полный макушки мне

не видать

Ладно без макушка ты переживем так а

ну-ка вот так лучше

Видно нет экран

в очках отражение смотрим

а

вот так

пошло

супер Так ну что давайте мы короче тогда

тогда

чем мне тут важного то было

секунду

давайте быстро попросим Ну короче в

Твиттере есть вот такой вот вопрос про

про

Каким путем обновляем куда и по нему

видно что Циферки далеко не в пользу

далеко не в пользу

[музыка]

неоднозначно половина людей обновляет

куб через создание нового кластера Ну и

во втором опросе видно что всего 10

процентов людей

обновляют автоматически там с помощью

какого-то

катаются автоматические обновления

Ну и опять же если посмотреть инфу из

релиза 119 там видно что

окно поддержки до увеличена с 9 месяцев

до года и виден график распределения

версии по нему Ну понятно что

большой очень хвост людей со старой

версией и как бы над этим что-то делать

Ну и почему так уже видели все смешную

гифку Но на самом деле реально со

стороны если вы не понимаете что

происходит то вот обновление обновление

Куба выглядит как

некоторая форма магии и Казалось бы

Понятно мужик это делает А вот повторить

самим

вряд ли кто-то из нас может еще

интереснее смотреть на вот этого

товарища понятно тут тоже что никакие

там законы физики не мешают так делать

Ну то есть это точно возможно но

я бы сказал я на сто процентов уверен

что никто из смотрящих не сделает я в

том числе ничто не мешает так делать но

никто не может ну короче

складывается впечатление что некоторые

магия

пока мы не разобрались Ну и собственно

цель моего доклада цель того что я

сегодня пытаюсь рассказать это показать

там на самом деле нет никакой магии там

на самом деле все продумано немножко

рассказать о том как это устроено Почему

так и так далее так вот

ещё момент вопрос поставлен неправильно

то есть правильно задавать вопрос как

обновить cubernets и не

не ошибиться

значит или даже правильно задавать

вопрос как безопасно обновить cubernets

И под безопасным и подразумеваем

Собственно как обновить губернатос без

простоя и с возможностью отката

значит я вижу вопросы кстати

в рамках доклада очень подробно отвечу

про доступные

айпишки

Значит так вот с моей точки зрения

правильно

вопрос будет звучать Как обновить

губернатос без простоя и с возможностью

отката и тут тоже есть неоднозначно

потому что когда мы говорим без простоя

Под каким простоем Какой простой мы

имеем в виду Да это простой только

самого Куба Или простой всего нашего

приложения там целого нашего продакшна

Разумеется как минимум без простоя

нашего приложения но лучше и без

простоя каких-либо компонентов

правильно вопрос звучит как обновить

кубернатор без простой кластеры

приложения с возможностью отката и даже

не обновить а обновлять то есть вот

Вот она постановка Да и собственно

доклад об этом доклад о том как

обновлять Кубы

Прежде чем я продолжу у меня быстро

рекламная пауза Мы недавно запустили

услугу менедж кубов Если вы откроете вот

эту ссылочку там будет описание все что

мы делаем в рамках менедж кубов мы можем

сделать кубы вашей инфре или даже дать

софт чтобы вы сами сделали кубы как у

нас с нашей поддержкой так вот Если в

рамках процессе моего рассказа у вас

будет возникать чувство что

короче сложная фигня Открывайте ссылочку

покупайте куб Извините что я торговлей

занимаюсь но это часть часть нашей жизни

так вот часть 1 что вообще такого в

обновлении когда мы что-то об этим

что-то

такого особенного такого страшного с

моей точки зрения самое страшное вещь в

процессе любого обновления потенциально

несовместимость Когда у нас что-то с

чем-то несовместимо вот вопрос что и с

чем может быть несовместим если мы

возьмем какую-то программу

понятно что есть функционал есть

формат котором эта программа хранит

данные и у нее есть наверное некоторые

механизм взаимодействия с внешним миром

как-то она обращается в какие-то внешние

штуки так вот когда мы говорим о

несовместимость потенциально

несовместимость мы имеем ввиду что она

может быть Вот где-то в одном из этих

мест у нас может быть может меняться

функционал может меняться логика работы

программы если раньше Она при нажатии на

эту кнопку при обращении там вот

какому-то методом теперь она начинает

делать другое когда

мы говорим про несовместимость формата

данных что новая версия программы не

может работать со старыми данными

форматы данных просто оказывается

несовместимыми Ну понятно Я думаю что

какие-то тоже несовместимости могут быть

так вот как решать причем Я говорю не

про купе говорю В целом в широком смысле

про любой софт потому что проблемы одни

и те же решение одни и те же и Давайте

будем честны Да куб это просто микро

сервисная архитектура

написанное

использующее для хранения поэтому как бы

если мы говорим про проектирование

любого другого приложения микро

сервисного или

вообще любого другого приложения

принципы остаются те же самые

так вот значит если мы говорим про

несовместимость

прежде всего там внутренней логики

работы ну и во вторую очередь

взаимодействие с внешним миром то

никакой магии тут никто не придумал

никаких решений нормальных тут нет кроме

одного

простого

и однозначного ответа что нужно писать

тесты нужно писать очень и очень много

тестов покрывать весь функционал тестами

и чекать что с одними и теми же тестами

проходят и старая версия и новая версия

и Чем более

высокоуровневые это Чем более энтонины

тем лучше можно проверить

несовместимость ничего кроме покрываете

софт рассказать нельзя понятно что в

кубе тестом выделяется

Гигантское Внимание В смысле

тестирования функционала и тестирование

совместимости функционала я не буду

громких слов говорить скажу

Может быть одним из лучших сортов вообще

на планете очень очень

вдумчиво тестируется API уже был вопрос

и понятно что там самое простое решение

по API Это версионирование пи ну и

давайте быстро посмотрим что такое

версионирование 5 чтобы все понимали это

однозначно на очень простом примере есть

нас такая вот Джо Сонина что это за Джо

Сонина нам ее клиент отправляет или

клиент получает ее в ответ да даже не

так важно Это некоторые там самые

простейшая

и понятно что мы можем без проблем

добавить

обычно добавить попиху

дополнительно не обязательное поле То

есть если мы добавляем например email

скорее всего не один клиент не

поломается скорее всего все будет хорошо

но если мы хотим взять и переименовать

то получается

потому что

потому что клиенты

понятно что отвалятся и все существующие

клиенты не смогут работать и понятно что

решать эту ситуацию можно там одним

единственным образом добавив некоторую

информацию о том в какой версии вот этот

объект и понятно что ее надо было по

хорошему добавить самого начала

изначально чтобы она была И когда нам

нужно переименовать поля мы просто

делаем новую версию которая тоже самое

называется по-другому или есть какие-то

обязательные параметры какая-то

несовместимость и дальше отруливаем от

руливаем эту ситуацию версиями и

фактически наша программа превращается

из вот такой В вот такую То есть у нас

не просто апев 1 апев 2 и дальше мы

следим за тем чтобы Один всегда был

совместим мы можем добавить в какой-то

версии который будет абсолютно

несовместим ни с чем но уже новые

клиенты там юзеры будут постепенно

переезжать со старого

как купе но я уже говорил Лучше не

бывает Есть очень подробный документ про

то как меня теперь в каких ситуациях

можно добавить поле в каких ситуациях

нельзя в каких ситуациях можно сделать

какую-то часть каких нельзя и подробный

документ который описывает как

откидывать старые версии 5 ситуации это

можно нельзя и так далее

я сейчас не буду вдаваться в подробности

но в целом из этого всего выводится Вот

такая вот здоровенная таблица

а и в эту таблицу Я тоже вдаваться

подробности не буду но по сути таблица

описывает там через сколько релизов

Какие Pi мы можем я к ней еще вернусь и

подробно мы ее разберем

но

короткий Ответ на то что делать там с

несовместимостью API Это версионировать

я думаю что теперь все там однозначно

понимают что мы подразумеваем

падрессирование

теперь что касается формата хранения

данных с моей точки зрения это самое

вообще страшная история и самая большая

сложность в написании софта Да это

изменение формата хранения данных А

зачем нам нужны изменения формата Мы

хотим добавить какие-то возможности Мы

хотим добавить какие-то данные вот

Как сделать так чтобы могли выкатить

новую версию которая добавляет какие-то

данные начинает хранить новые данные Так

что больше ничего не поломалось чтобы

могли откатываться Мы помним да э задача

э обновляться без простоя и откатываться

иметь возможность откатиться

кстати

формат хранения данных немножко

пересекается с форматом обращения к

внешнему миру потому что

на самом деле Давайте сосредоточимся на

этом формате хранения данных

это главное с обращением к внешнему миру

разберемся по ходу так вот когда мы

говорим про изменение

формата хранения данных у нас обычно

первое слово которое возникает это

миграция данных миграция формата

изменения схемы и первое у меня

ассоциация но я думаю большинства

которое возникает это вот такая гифка ну

и собственно вопрос который возникает

сломал ли чувак шею или или просто

намочился но как бы понятно что очень

страшно очень стрёмно еще вот есть такой

вариант

[музыка]

который для меня символизирует следующую

мысль что если мы данные

даже если у нас вот вот уже почти все

получилось

в любой момент это может быть там полным

провалом

от любого неосторожного движения Ну и

я забыл о чем дальше при этом значит

когда мы говорим про миграцию Да когда

мы говорим про формат хранения данных

вот у нас

как бы вот это же кусок нашей программы

то есть программа данные и собственно

формат по которым она взаимодействует

если мы говорим что

у нас прога версии 1 данные в той же

самой версии схема в той же самой версии

то давайте посмотрим как вообще может

миграция выглядеть на практике вот у нас

есть софт первой версии данные в первой

версии Мы хотим выкатить новую версию

при этом мы вот в самом тупом варианте

мы останавливаем старую версию запускаем

какой-то мигратор который конвертирует

наши данные получается новая версия

запускаем новую версию все классно все

работает но понятно что если мы пытаемся

с этими данными запустить старую версию

у нас ничего не заработает Все плохо и

понятно что

собственно откат невозможен и при

простое при обновлении у нас простой А

надо понимать что как бы там все всю

историю айтишки мы жили плюс-минус Вот с

таким способом обновления и в последние

10 лет это начало более-менее меняться

то есть еще там 10 лет назад все

обновления выкатывались через мы

остановили сделали мы что-то покрутили

сделали бы как бы по классике что-то

поделали чтобы с мигрировать на новую

версию Ну и запустили новую версию

понятно что мы не хотим так понятно что

мы хотим по-другому и общий паттерн как

вообще всегда такое обновление

происходит он всегда выглядит одинаково

у нас работают обычно несколько версий

текущих мы запускаем миграцию которая

мигрирует схему таким образом что старая

версия продолжает работать с новой

схемой данных то есть

такой значительное значение

накладывается на способ миграции типа

делать изменения которые обратно

совместимы я об этом сейчас еще подробно

поговорю Что такое вообще обратно

совместимые изменения все классно

понятно что когда мы хотим обновить

новую версию мы можем

одно их менять беспростое все классно

понятно что мы в любой момент можем

откатиться также по одной все классно То

есть у нас откат возможен В любой момент

и у нас нету простоя для того чтобы это

делать нам нужно делать обратно

совместимые изменения

и у меня есть

как бы понятно что когда мы говорим про

кубы это там ему Джи Сон протобаф на

худой конец но мне есть примерная сквили

Я считаю что правильней приводить

примерное сквеле Потому что

потому что гораздо более Понятно всем и

гораздо более наглядно а принципы все

равно те же самые то есть разница между

тем как мигрировать протопов

или мигрировать же сон с Open A5 с пекой

от того как мигрировать SQL табличку или

нет никакой принцип действия вот все то

же самое но примерно скрыли гораздо

нагляднее так вот есть нас наша прога И

представляете что здесь у нас SQL значит

вот у нас есть некоторые табличка с

юзерами

username все те же самые

данные и представим себе что заведено

три юзера представим себе что наш прога

отправляет какие-то запросы представим

себе что нашей проги есть какое-то

внутреннее представление данных

достаточно наглядно видно что таблица

то как это устроено в стороже это как

это устроено внутри плюс минус совпадает

но все равно есть внутренний формат есть

формат хранения это все-таки там два

некоторых разных формата два некоторых

разных представлений

вот допустим мы хотим добавить новое

Поле Мы решили собирать дни рождения это

делается очень просто выкатываем новую

версию Она видит что нет колонки с Днём

рождениями добавляет эту колонку тем

самым происходит миграция данных

обязательно колонка должна быть

опциональной она не может быть

она может быть обязательной Ну иначе

старая версия перестанет работать ну и

новая версия начинает слать чуть-чуть

другие

обращения и начинает

[музыка]

иметь другой формат представления данных

понятно что вот для юзера 21 там пока

что

э Now Да но со временем

User будет обращаться к нашей системе мы

не будем запрашивать там дни рождения со

временем они заполнятся и в какой-то

момент у нас искали таблички и во

внутреннем присоединении появится

появится день рождения Окей классно в

целом эти две версии могут работать

параллельно они друг другу не мешают

могут работать сколько угодно Долго но

скорее всего мы в какой-то момент старую

версию отключим

значит и как бы Забудем о ней нас

Останется только вот это вот версия 2 но

тут происходит страшное мы тут понимаем

что мы храним дату рождения дата

рождения персональные данные нам нужно

появлять проявлять какие-то нам нужно

выполнять какие-то там особые требования

хранения этого потому что это разданные

сложно страшно Но мы понимаем дата

рождения совсем не нужно достаточно было

возраста

и вот у нас возникает задача давайте мы

день рождения заменим на возраст И

это вот тот самый пример

наглядный хороший несовместимого С одной

стороны очень простое Ну понятно же как

за дня рождения возраст вывести То есть

можно взять просто данные с конвертить и

не париться это изменение несовместимые

из-за того что они совместимые

приходится устраивать

очень-очень сложные обряды

Давайте посмотрим

последовательность действий как это

делать

мы выкатываем новую версию

которая подключается к базе видите что

там нет колонки с возрастом и добавляет

колонку с возрастом не обязательно

опциональную никак ее не заполняет

скорее всего

и начинает работать колонкой То есть это

изменение безопасности с него можно

назад откатываться потому что мы просто

добавили колонку ничего страшного

понятно что вы скелет запросов у нас

появляется Edge понятно Что еще нас пока

никак не заполнен но В3 по мере работы

когда на пересохраняет юзеров Ну или мы

можем сделать некоторые миграции она

начинает заполнять

и в какой-то момент у нас оказывается

заполненным все классно но мы можем без

проблем смотри откатиться на 2 и ничего

не поломается дальше мы выкатываем

следующую версию

которая перестает

читать

дату рождения перестает с ней работать

и во внутреннем представлении у этой

четвертой версии тоже нет И теперь юзер

уже не может заполнить в интерфейсе дату

рождения может заполнить только возраст

если он заполнит возраст мы потом

откатимся назад то возраст как бы

пропадет потому что у нас будет версия

вторая третья не спрашивали день

рождения некоторые страшные и скорее

всего Скорее всего у нас данные там

особо не потеряются дальше

следующую версию которая запускается и

она удаляет колонку С даты рождения

и надо понимать что

внутреннее представление данных и SQL

запросы никак не меняются Но вот эти две

версии становятся в этот момент

debrecated потому что их уже нельзя

использовать потому что они когда

подключаются к базе они рассчитывают что

там есть колонка если если вдруг

Мы попытаемся к ним откатиться у нас не

получится то есть смысл такой для того

чтобы сделать

несовместимые изменения в формате

хранения данных нам Обычно нужно три

релиза в первом релизе мы добавляем

новый формат во втором релизе

мы перестаем использовать старый формат

и в третьем релизе мы удаляем старый

формат и только при таком

При таком процессе только при такой

последовательности мы гарантируем себе

две вещи которых мы которых мы ждали это

отсутствие простое при обновлении и

возможность только при таком подходе мы

делаем откат безопасно

а как

устроена в cubernetis с миграцией данных

Мы помним что куб хранит

данные в отсети Да и при обновлении

версии Куба ему надо как-то мигрировать

данные

Ну и ответ вы уже видите на экране Лучше

не бывает картинка следующая вот если мы

смотрим опять на какую-то программу да

то в случае с кубом вместо формата

данных там используется Ну просто

протобан с

тем же самым что приходит то есть у нас

есть

спецификация того как выглядит Джи

Сонина в apv1 и спецификация того как

выглядит Джо Сонина 2 и куб хранить

данные в одном из этих форматов я чуть

позже еще более подробно об этом

расскажу когда мы разберем с вами

табличку

начну опять подробности можно прочитать

в том же самом документе там подробно

изложено шаги действия как это

внутренние происходит

а ну собственно Давайте вот табличку

разберем Мне кажется из нее станет все

очень понятно во-первых

колонка с релизами значит ну надо

понимать что здесь X Это например там ну

один X это Например 1 15 1 X + 1 это 116

1 x + 5121 плюс 17 это

132 воображаемый на который ни у кого

нет планов значит вот эта колонка

говорит какие версии API в

заданном релизе поддерживаются А вот эта

колонка говорит В какой версии API

данные куб хранит данные вот сети вот

смотрите если мы возьмем Вот этот

какой-то версию какой-то релиз и

посмотрим опять на вот эту картинку то

вот это перечень опек поддерживаемых это

по сути Сколько дырок у нашего У нашего

пещера Сколько дырок у наших разных

дырок сразу с разными требованиями с

разной спецификацией сколько и какие они

А вот эта колонка это формат в котором

собственно у нас сохраняются данные вот

сиди При этом надо понимать что внутри

куб это все конвертит какую-то свою

форму но это не важно потому что он

может конвертить из любой версии API в

любую другую через эту внутреннюю форму

и соответственно объект сохраненный в

одной форме может отдавать в другой и

так далее

Ну и надо понимать на самом деле вот

сидел нас может храниться не то что

указано В2 А может храниться в один

Почему Потому что мы еще не перезаписали

этот объект только обновились ту версию

в предыдущем релизе формат хранения был

В1 в новом релизе В2 значит

соответственно эта версия Она читает

читает данные в любом а записывать

всегда В два то есть тем самым

происходит плавный апдейт

Ну может быть на самом деле даже не В1

могут быть более старые то есть

поддерживается вообще на самом деле

любая из из поддержанных куб может

прочитать данные зацепи в любом формате

Окей давайте теперь быстро посмотрим

вообще что происходит с опихами вот у

нас добавилось в один Альфа 1 в

следующей версии у нас Ее уже нету ее

поддержку удалили Почему Потому что это

Альфа и в этом смысл Альфа чтобы можно

было удалять без проблем если мы говорим

про вот здесь появляется один бета и

вот здесь появляется версия на смену но

при этом Обратите внимание что уходит

три релиза для того чтобы depricated

версию удалить а три релиза это там

считаете год практически 9 месяцев

то есть от появления от того как бета и

Пиа и стала проходит 9 месяцев на то

чтобы перестать этим пользоваться если

мы говорим про Выход стабильной версии

дата вот стабильная версия debrakitty

через 5 релизов после после выхода новой

Теперь смотрите какая ситуация вот у нас

появилась версия

появилась версия Вот она начинает

использоваться для хранения в следующей

версии Потому что если мы начнем хранить

сразу же Если мы разрешим хранение в

этой версии сразу у нас не будет

возможности отката

если бы мы в версии x плюс 3 сразу бы

начали хранить в этой в этой опеки

В1 то

мы бы не могли обновиться мы бы не могли

откатиться на x плюс 2 мы когда

обновляемся на x плюс 3 у нас появилось

новое когда обновляемся на x плюс 4 у

нас начинает пользоваться для хранения

Тем самым у нас всегда гарантируется

возможность отката назад на одну версию

больше чем на одну не гарантируется Даже

скорее всего не получится вот на одну

гарантирует

Ну то же самое вот там другие примеры

точно так же когда стабильные piv1 тоже

самое когда стабильная epi V2 релизется

надо заметить то что когда кроме V1

появляются еще там Альфа очки или

беточки В2 они не используются для

сторожа Ну для того чтобы не не

усложнять процедуру

Окей значит и того для того чтобы

сделать безопасное обновление в общем

смысле первое версия нервами пиай второе

обратно совместимая иммиграция данных

как ее делать более-менее разобрали Я

думаю что более-менее Понятно Ну и тесты

тесты тесты и еще раз тесты

другому не бывает если говорить про куб

то по сути идеальный софт для того чтобы

обновлять потому что вот все продумано и

все сделано для того чтобы его можно

было обновить

а следующий кусок называется что

происходит внутри Куба смотрите в

прошлой части мы очень быстро посмотрели

Как оно там в теории

как оно в основных принципах Да а вот

здесь хочется посмотреть как же куб

устроен внутри для того чтобы понять

какие там вообще могут быть там проблемы

несовместимости Ну и я напоминаю кстати

про ссылочку Извините за агрессивную

рекламу Но если вдруг вам хочется

Откройте ссылку Там вся инфа так вот куб

кубовое пи Мне очень нравится

представлять кубовое пи как

файловый сервер в котором на Каждый

каждый тип

данных на каждый тип объекта своя

директория а сами объекты некоторые ему

файлики ну или там Джейсон файлики

неважно в этой директории но надо

понимать что правильно говорить о том

что это двухуровневое дерево Да и первый

уровень это версии а второй уровень Это

тип данных надо понимать что мы говорим

про дипломат то у нас несколько версий в

каждой из них есть дипломмент

в каждой в каждом если в первом версии 1

есть у нас 3 момента то эти же три

дипломата есть во всех других потому что

это одни и те же диплоинд это просто

разные отображение разные представления

одних и тех же данных и мы можем любой

момент подключиться и сказать куб Дай

нам

подключиться к версии 1 и сказать куб

Дай нам диплоинты версии 1 или

подключиться к версии там В2 Альфа один

и сказать Дай нам дипломанты в два Альфа

1 и это будут одни те же самые дипломы

просто представленные по-разному куб нам

будет на лету конвертировать из формата

хранения формат представления Когда мы

будем отправлять изменения будут

конвертировать обратно сохранить этот

весь весь онлайн конвертации выполняются

постоянно и на лету Давайте Вернемся

Давайте откинем эту историю

сверкционированием Мы помним что А

петерсонированная Мы помним что там есть

версии Ну давайте Вернемся вот если нас

диплоинд есть реплика сеты есть под и по

сути вопихи У нас есть там три

принципиальных метода Get Put

причем тут у нас там с валидацией Да и

есть Watch и когда мы делаем вот мы

говорим Хей куб шли нам апдейты по по

изменениям какого-то объекта и нам

приходит апдейты и каждый апдейт

приходит с той же самой версии которые

мы там запросили это вот все

версионирование

версии они так вот на базе этого

нас работают контроллеры и контроллеры

грубо говоря бывают двух типов одни но

своего рода Клаус глуп на которые читают

какие-то данные с Куба и пишут обратно

же вкупность читают данные записервера и

пишут обратно в ope сервер и второй тип

контроллеров который читает что-то из

API сервера и пишет во внешний мир на

самом деле может читать из внешнего мира

и писать сервер как-то как-то

синхронизирует

внешний мир с апе сервером так вот если

мы посмотрим конкретный пример нас юзер

пошел создал дипломом что при этом

происходит купе У нас есть дипломинг

контроллер это часть куб контроллер

менеджера Он подписан на дипломинты и

При появлении дипломинка он создаст

реплика с

смысл этого контроля в том что прочитать

одно создать другое и по сути это

отдельная программа которая подключена к

серверу по версии уже думаем как это

обновлять то есть

я думаю появляется некоторые

картинка вырисовывается вторая

штука контроллер когда появляется

контроллер видит и создает два под Когда

появляются поджиллер видит и прописывает

в эти же пода информацию о том на какую

ноду

запущенные на ногах и они видят

появление

на основании этих кодов создают

контейнеры в докере и когда контейнеры в

докере успешно создались по мере их

создания кубе лета репортят статус

обратно в

под записывают информацию о статусе

создания контейнеров входа

дальше

реприкасат-контроллер видит что поводы

идут вперед что у них там получается

запустится Еще еще что-то и обновляет

статус в реплика сайте

дипломат-контроллер делает то же самое

для дипломинка и в итоге юзер у нас

видит в дипломите информацию о том что

он успешно выкатывает что создается

реплики Там и так далее То есть вот

такая вот портянка связанных друг с

другом связанных друг с другом

компонентов и все они работают

прогрессированные 5 при этом Теперь

смотрите

вот эта штука это обращение внешнего

юзера так Кубу Вот это внутренний

interaction внутри кубе используется то

же самое 5 юзер и внутри мы

взаимодействуем по тому же самому API А

вот это обращение к внешнему миру там с

версионирование мы 5 чуть похуже

Ну я к этому еще вернусь

значит Ну и давайте быстро Вот это у нас

Контра Plane это узлы по сути Вот это

опе сервер вот этот кусочек это вот это

контроллер менеджер это sketcher

[музыка]

значит Поехали дальше А ну и билеты это

Билет Я думаю что всем понятно То есть

Давайте там не делая выводов Да но уже Я

думаю что какая-то картина

вырисовывается как компоненты друг

другом взаимодействуют и как их

апдейтить и у нас

следующий кусок и Давайте посмотрим

в целом вот более-менее реальный

инсталляции Как выглядит и что нужно

сделать для того чтобы его апдействовать

есть у нас какая-то виртуалка на которой

стоит кубелят с докером кубилет читает

папочку с манифестами в Кубе есть

возможность создавать коды не через

опиху А через папочку так

разворачивается всегда contropain и на

основании этих на основании этой папочки

билет по сути создает там 4 подана Тачки

Ну то есть читает из

папочки из директории и ходит в докер

создает контейнеры Мы помним Да что это

как бы Сервер это контроллер менеджер

это скетчлер это купили это то есть вот

у нас Один узел на котором запустилась

все все

четыре компонента которые мы говорили до

этого

при этом понятно что сиди хранить данные

где-то на диске понятно что сервер

хранить данные при этом если

возвращаться вот этой картинке

получается интересная штука вот это уже

не какая-то программа

И если мы говорим про хранение по сути

сервер сохранить данные вот сиди хранить

данные в уже на диске то есть у нас

получается как бы такая двухслойная

штука при этом В каком формате сервер

хранить данные вот сидим мы знаем это

[музыка]

в

протобафе Согласно спецификации epi А в

каком формате хранит седи данные на

диске нам не очень

Когда мы говорим про обновление самого

от сети

это важно но когда мы говорим про

обновление Куба Наверное мы можем эту

часть скинуть потому что это уже слишком

сильные Дебри И зачем нам туда Ну то

есть в контексте этого доклада нам это

точно не интересно мы считаем что это

сиди нам делать какую-то магию что его

можно обновлять или мы его не обновляем

Кстати мы к этому Вернемся чуть позже

Окей

дальше понятно что билеты подключаются к

серверу Скет же подключается к серверу

контроллер менеджер подключается но на

самом деле с этим есть вопрос потому что

так во-первых конечно же у нас

мастер ни один мастеров несколько и

конечно же у нас другом взаимодействует

но

рисовать такую стрелочек я буду рисовать

вот так даже вот так в данном случае FM

это Full mesh все связаны друг с другом

просто мяч в иллюстрации

[музыка]

Невозможное количество

стрелочек

становится

нечитабельно так вот

это вот некоторые

минимальный вариант установки Куба Но мы

же понимаем что по-хорошему вместо того

чтобы делать Вот так нам надо завести

лот балансер и

Слот балансера разбрасывать запросы по

серверам А уже все остальное подключить

к этому

сразу Задумайтесь Да если мы что-то

обновляем

например какой-то сервер а значит у нас

клиент может случайным образом

подключиться или к старому по серверу

или к новому pixer и видим Так что из

этого клиенты

я к этому еще вернусь на самом деле

Вот такая схема столкнулся не очень

работает на железе когда мы на железе Мы

обычно Ставим на тачку которому

подключается всю А дальше уже

с одного узла подключается к сервером

всем то есть каждого узла как ко всем ко

всем

Ну и для того чтобы нарисовать кучу

стрелочек я просто буду такую вот

абстрактный балансер понимаешь что этот

доллар целится это какая-то реализация

стримовый или

прямо

какой-то способ

Ну и надо понимать что самописейвер

по-хорошему ходит тоже не только в свою

локальную в свой локальный судья

по-хорошему он ходит во все при этом в

опе-сервере так написано гохи там гошный

Клиент от сиди ему из коробки можно

передать несколько поинтов

соответственно Вот балансер это просто

часть логики работы от CD липкие цели

клиента гошного то есть мы просто

несколько серверов несколько раз

Передаем Вот такая картинка то есть

когда мы говорим про обновление мы

должны понимать эту картинку и должны

понимать какой последовательности

обновлять элементы для того чтобы там

все получилось корректно

ноды Разумеется У нас есть ноды у нас

было три особых ноды которых у нас

мастера запущены но еще у нас есть

обычные Разумеется на ноги у нас билет с

докером с балансером то есть билет ходит

балансер и ходит в докер и я Напоминаю

что вся смысл Смысл работы билеты

синхронизировать данные между сервером и

докером грубо говоря некоторые конвертер

из докторов

а ну и соответственно нот у нас много

Окей вот то что нам нужно обновлять

Давайте разберемся что мы здесь

обновляем и как во первых значит

операционная система

версии ubunty или santasia версии ядра

какие-то другие системные компоненты

с моей точки зрения это Out Of scope с

одной стороны с другой стороны никакой

проблемы с их обновлением нет мы просто

выводим там Но если нужно обновить

перезагрузка соответственно мы выводим

узел в режим и просто обновляем

Мне кажется это не про обновление кубах

вообще но в кубе для этого все

предусмотрено потому что обычные узлы

можно дренить разогнав с них поды и без

проблем обновлять Единственное что Если

ваше приложение написано плохо и его

нельзя выгнать с узла то есть при

приостановке она начинает 500ки делать

да то как бы конечно же будут проблемы

500 при этом но тут такая ситуация что

есть у вас эта проблема есть то вы

каждый диплом вас там с 500 в любом

случае перешатывание приложения понятно

что если у вас приложение хранят

какие-то локальные данные на узлах У вас

начинается проблемы Но это опять это не

не ограничение Куба это ограничение

вашего приложения но в целом обновление

операционной системы не вызывает никакой

проблемы и в Кубе есть все механизмы для

этого с точки зрения мастеров можем

любой мастер погасить два продолжит

работать потому что корм для трех узлов

это два достаточно

докер во-первых

там Совершенно не обязательно докер Да

могут быть другие имплементации

во-вторых что касается даже самого

дойкера то там с обновлением тоже все не

однозначно Потому что есть там два

способа есть там докер по новее есть

докер менее новый но смысл в том что у

нас например у Fanta не было ни разу

опыта успешного обновления Докера на

Живую То есть когда мы билет продолжает

работать контейнеры продолжают работать

Мы на тачке втихаря меняем докер и все

как бы без проблем нет так вот у нас не

получилось Мы пока что обновляем докер

точно так же как обновляем ядро на

операционки освободили тачку поменяли

докер но надо понимать что докер

обновление тоже не про обновление мы

говорим что мы обновляем куб они не

которые там внешнюю зависимость но в

целом с

обновлением Докера я бы сказал что

наверное худшая часть Я знаю что

возможно Кстати этот вопрос нормально

решен мы просто во флансе еще не

соскочили с Докера на какой-то другой

серый

какой-то другой контейнер runtime и

возможно этот вопрос решен вот в докере

у нас не получилось

а купили это значит с кубелетами в целом

В общем случае их можно все обновлять на

лету без проблем

но мы к этому еще немножко Вернемся

значит Control

Давайте подробно разберем как

обновлять Control plain А точнее даже не

как до того как обновлять надо

разобраться с тем как обновлять сидит

давайте разберемся тем как обновлять

очень просто Значит есть версия Кубан

есть версии некоторые абстрактные вот в

той версии в которой сейчас у нас

поддерживается N версий

следующий поддерживается тоже на других

значит

механика очень простая нужно найти ту

версию среди которая поддерживается и

там и там и обновиться на неё А уже

после этого обновлять

но в целом У нас очень и очень и очень

позитивный опыт обновления от сети ни

разу никакой значительной проблемы с

этим не было

у нас больше 150 мастеров и вот ну ни

разу проблем с обновлением xcd не было

кластер из трех узлов Один узел

остановили за бокам снапшотнули не

гранули запустили в новой версии он

работает со старыми потом второй потом

третий все классно после того как мы

Обновили все сиди на некоторую

совместимую версию а чаще всего при об

этих кума даже соединение обновляем

потому что он не так часто выходит

после того как мы навели мы идем уже

Есть мысли

[музыка]

я вернусь запомните вопрос Задайте в

конце Я сейчас собьюсь короче

вопрос был в чате если мысли съехать на

другой runtime мысли есть такие чуть

подробнее рассказываю позже Значит

короче когда Мы возвращаемся к этой

картинке

надо понимать что

вот у нас в новой версии появляется вот

эта API V2

так а

но если мы сначала обновим клиентов

которые пользуются этим apf 2 а потом

сервер то ничего не выйдет потому что мы

сначала должны обновить сервер чтобы в

нем появилась поддержка от его 2 а потом

клиента соответственно мы

обязательно шым образом сначала

обновляем Аппе сервера при этом вот

просто Задумайтесь мы Обновили один

допустим у нас все на один 15 один из

записи роста на 16 это значит запросы от

кубелетов от скетчжулеров от контроллер

менеджеров случайным образом попадают то

в сервер 115 топе Server 116

при этом может быть один 16 сохраняет

данную уже в другом формате но вы

помните Да что он может начать сохранять

данные только в том формате который

появился в предыдущей версии

соответственно все другие описано тоже

смогут считать из CD то есть в целом это

абсолютно корректное состояние когда у

нас API сервера разных версий Главное

чтобы они не находились больше чем на

одну Ни в коем случае и главное чтобы у

нас не было ни одного клиента пока мы не

Обновили все API сервера на новую версию

у нас не появилось ни одного клиента на

этой версии сначала нужно обновить

всякий сервера как долго они обновляются

это неважно И это абсолютно безопасно

это не вызывает никаких проблем Обновили

все эти сервера После этого мы в любой

последовательности не важно как

обновляем контроллер менеджера искатели

Дело в том что они все работают

и

для них для всех достаточно чтобы хотя

бы один элемент был запущен с их

обновлением вообще никакой проблемы нет

лишь бы сервер уже поддерживал новые

опеки в которых эти компоненты могут

начать обращаться Окей как откатиться

смотрите уже говорил что нельзя

допускать ситуации то что клиенты

свежее сервера никогда соответственно

прежде чем даунгрейдить апи сервера Мы

должны даунгрейднуть всех клиентов то

есть сначала даунгрейнинг клиентов потом

Аппе сервера это CD скорее всего не

даунгрейдинг потому что это сети

мы же мы даунгрейднуть потому что что-то

пошло не так да соответственно мы будем

опять апгрейдиться зачем нам это сидит

туда-сюда дергать на самом деле и

сервера мы можем не откатывать насколько

откатывать можно решать никакой проблемы

с откатом нету главное соблюдать

последовательность сначала откатываем

клиентов потом откатываем сервер билеты

Билеты самые обычные клиенты

соответственно их обновляем Просто после

сервера в любом порядке как я уже

говорил зачастую их можно обновлять на

Живую даже не трогая не выводя ноды

мейнс проскакивать я сейчас расскажу

каких ситуациях можно

Окей кстати еще по кубелетам в целом

точно так же как контроллер менеджер

точно так же как sketing их можно на

самом деле вообще любые клиенты можно

держать не на одну версию назад она

больше версии назад то есть ничто

глобально в этом не мешает просто это не

очень рекомендуется соответственно Ну

если вы обновляетесь на несколько версий

вам хорошему

API поднять на одну потом всех клиентов

во всех возможных вариантов поднять на

одну Потом еще на одну клиентов на еще

на одну и так в общем по одной идти не

устраивая расхождение больше ну и

откатываетесь

клиентов можно откатить на одну клиентов

можно отходить откатить на больше а

сервер никогда нельзя откатывать больше

чем на одну версию почему надо открыть

табличку и понять потому что там как бы

сервер Мог уже начать хранить в новом

формате в откатаемся на предыдущую

версию там этот формат точно

поддерживается она пред предыдущую Нет

он не поддерживает соответственно пещеры

можно откатывать только на один

на одну минорную версию

окей

Еще момент Черт побери А ну быстро и

того Да значит при обновлении сначала

сервер Потом клиенты при откате сначала

клиента потом серверы Все понятно Значит

еще один момент по вот этой вот картинки

надо понимать что это это все всего лишь

узлы до а поверх этого у нас уже еще

работать много чего и вот если это

физический уровень У нас есть еще

уровень самого Куба в котором У нас есть

например demans от синаем Ну и надо

понимать что есть внутри Куба есть та же

самая пиха тот же самый какая-то другая

скорее всего другая Но неважно И надо

понимать что Синай это если вдруг кто не

знает Ну скорее всего все кто не знает

что такое уже отвалились этого доклада

потому что они умерли

сложности

Но короче сена это контейнер нет короче

[музыка]

сетка Господи реализация сети в кубе их

там может быть много разных но он скорее

всего подключается капе и скорее всего

его обновлять надо то есть не скорее

всего обновлять его надо после сервера

дальше тут начинается вопросы в том что

скорее всего Синай

обновляется не так быстро как кубы и

скорее всего Сенная написано просто что

поддерживается

версии вашего сено этом фланеля или

Калика или чего там написано поддержка

кубов не менее там один X и вот Смысл в

том что если вы хотите новый функционал

в семинарии вам нужно сначала обновить

кубы до этой версии только потом ставить

дальше там особый Разницы нету все сайты

сторож интерфейс скорее всего заказывают

тоже штука подключается тоже надо

обновлять

на самом деле DNS еще на самом деле

много компонентов Да их тоже надо

обновлять но

принцип там точно такой же Обновили сам

куб дальше просто спокойно обновляем

компоненты уже средствами

Куба есть еще диплом контроллер

менеджером эта штука которая

тоже надо обязательно обновлять И

это еще одна вещь которая

а часть 4 и как обновить губернатос

Напоминаю что вопрос на самом деле как

обновлять губернаторством без простоя

кластера и бла-бла-бла Ну ответ к

сожалению Все такой же и смысл следующий

что с одной стороны в кубе все сделано

для того чтобы можно было

обновлять нужно просто взять и обновлять

другой вопрос что

минорная версия Куба выходит раз в три

месяца

почти Лиза выходят Ну можно считать что

там два раза в месяц

получается что нужно два раза в месяц

сделать незначительный апдейт

и раз в три месяца значительно апдейт

временно подготовку такого апдейта может

занимать там недели или месяцы в итоге

получается так что нас там какая-то

группа людей должна быть на Full Time

занята просто чисто

подготовкой обновлений

реальные проблемы обновления во-первых

рестарт контейнеров до 1.16

возвращаемся к этой картинке и смотрим

на вот этот interaction до версии 1.16

кубилет делал контрольную сумму

внутренней гошной структурки и на

основании этой контрольной суммы чекал

правильно или у нас контейнер в докере

соответственно когда мы меня обновляли

кубилет и там менялась эта горшная

структурка внутренняя которая никак не

стандартизируется ничего тут же менялась

контрольная сумма и тут же контейнер на

ноги и все удалились

в 16 версия 1.16 это контрольную сумму

перестали считать на основании горшной

структурки начали считать на основании

объекта

значит

и оно все стало совместимое Но это

означает что обновление на 116 это

рестарт всех контейнеров класть

слава Богу ни одномоментный то есть на

каждой ноте мы выкатываем мы обновляем

билет на одной ноте в этот момент на

этой ноте все контейнеры соответственно

прежде чем обновлять нужно ноду

задроинить нужно выгнать ноды контейнеры

можно будет

ссылочка на пул request который пофиксил

эту несовместимость сделав больше

проблема Это не будет но при обновлении

на 1.16 это боль

второй момент уже задавали вопросов про

отключение опих Дело в том что тот факт

что пихать и прикрепиться в этом нет

проблемы есть проблема в том что когда

депрессин это пиха уже несколько

несколько релизов отключается и вот инфа

о том что отключается в 116 на самом

деле 116 такая штука где все отключили

Давайте очень много отключений в 1.16 и

вот тут много раз написано из No Long

Soft Это означает что куб еще с точки

зрения формата хранения данных этапе

поддерживает но он больше

дырку закрывает

[музыка]

закрывает больше больше напит не

отвечает и понятно что это проблема но

об этом предупредили за 4 за пять за три

за много релизов до этого и как бы все

давно об этом знали Ну да в какой-то

момент надо старая вещь удалять это

больно но

это можно пережить на на то чтобы это

сделать было 5 версий Куба да или 4 в 11

прошлого удаления было соответственно 12

14 15 обновлялись без проблем с 11 на 12

на 13 на 14 на 15 обновлялись без

проблем Единственная проблема это

обновление на 16 и следующее кстати

проблем будет обновление на 22 там еще

кое-что удаляется

так вот

реальная проблема заключается в

следующем

невозможно отследить используемые версии

Pi то есть вот смотрите вот у нас есть

опять это картиночка да И вот есть

некоторая версия и когда мы обновляемся

на следующую версию у нас одна из apix

перестает сердца то есть ей больше

нельзя воспользоваться вот вопрос в том

как найти клиентов которые пользуются

этой версией опеки

по-простому если мы обновим куб все

продолжит работать стопроцентно потому

что компоненты Куба тестируются друг с

другом но у нас диплом перестанет

работать потому что у нас может быть в

каком-то химе или в каком-то там

использоваться старая версия пищи и

оплай или там просто перестанет работать

И вот вопрос том как найти все мы в

которых у нас объект вне той версии и

ответ никак потому что не знает в какой

версии объект был создан потому что мог

быть создан одной изменен в другой потом

изменен в 3 потом обратно во второй и

Это же просто как бы проекции

представления призмы через которые можно

работать каждая версия и куб не следит

не знает какой версии был создан

Если вы пользуетесь используете laplay

там есть аннотация в которую изначально

объект для того чтобы работал

трёхсторонний марш по ней можно понять

helm создает релизы в кубе отдельные

отдельные секретики или отдельные

конфигмепы в которых он хранит Ну как бы

копию чарта которую накатал по ним можно

понять в итоге при обновлении на 116 нам

планту пришлось очень много работы

проделал для того чтобы найти все эти

холмы но я сейчас чуть подробнее

расскажу об этом

Окей то есть при обновлении у нас три

реальные проблемы рестарт контейнеров до

1 16 после 116 проблем нету отключения

API в 116 есть и будет в 122 если ничего

не путаю она не путаю один раз два будет

[музыка]

ищем Проблема в том что очень сложно

следить Можем ли мы уже апдействовать

Мы точно можем это ничего не поломать

текущей работе но

на следующий день когда придут там

команда разработки попытаются катануть

новую версию им скажет И это будет как

бы большое расстройство

часть 5 я понимаю что я уже долго очень

говорю я заканчиваю

значит фланта сейчас 150 мастеров стат

по

провайдерам следующая Мы не пользуемся

менеджетом типам у нас всё менедж нами

и соответственно видно что половина

приходится на некоторые клауды вторая

половина 44 процента это ATR и Water у

нас попадает из клаудов наверно только

эйджер те клауды которые мы не

поддерживаем там не знаю

и большая часть там железа или просто

статические виртуалки это просто чтобы

некоторое понимание было Вот сейчас у

нас всего 6 кластеров на 114 и мы их не

будем обновлять Дело в том что они

созданы копцам Если кто-то знает а мы с

ним восхищаем это как бы

кластеры такие поджиганием все остальное

у нас обновлено на 115 или на 116 и вот

с обновлением на 16 реальных стреляли

надолго и очень давно боремся

проблемы я рассказал какие то есть

подразумевает рестарт всех узлов

кластеры во-первых

во-вторых Это подразумевает поиск всех

холмов изменения а для понимания у нас

больше двух тысяч приложений в кубе

работает Уста клиентов это грубо говоря

поправить 2000 готовых репов в 100

гитлабах Ну как бы и перекатить

приложение значит не просто поправить

это удостоверение что накатывается это

занимает некоторое время и мы застряли

вот как бы такая картинка но по

обновлениям Я точно знаю что из этих 150

костеров нас есть кластеры созданные в

17 может быть в 16

но как минимум в 1.7 созданные и успешно

обновленная до 1.16 То есть у нас есть

кластеры родовые важные ответственные на

железе которая с 17 до обновились до 116

и мы знаем что скоро они полетят на 119

Это нету никаких

экспериментальное Доказательство есть то

что куб реально можно обновлять

а как мы обновляемся 1 15 x на 115 Y

патч релиза мы катаем полностью

автоматом У нас есть понятие каналов

обновления и у нас 150 костеров разбиты

по каналам обновления мы просто в канал

обновление отгружаем Типа все теперь не

один 15 там 10 11 15 11 кластеры

обновились и Control plain и опи сервер

из кейджер и контроллер менеджер и

кубилеты на всех нодах и

мы так делали много раз вот не единого

разрыва никто не замечает у нас там

очень много мониторинга и внешнего и

Смоки это куча кластеров прекрасно

катается на Живую вот вообще без единой

проблемы

обновление 11516 я уже говорил

мучительное и мы сейчас дожидаемся

последние кластер нажимаем не так много

осталось

по сути У нас есть мониторинг который

говорит мы с к ним

релизы в кластеры сканером разные другие

параметры нас есть мониторинг что

кластер пока нельзя обновлять и

собственно У нас есть там

красный список кластеров которые надо

со стороны холмов со стороны того что

диплоится поправить

значит

1 17 1 18 Мы решили пропустить Мы точно

также пропустили 113 114 и 11 12 11 13

14 мы обновлялись 11 15 напрямую понятно

что не напрямую Но вопрос том что у нас

кластер находится в промежуточных

версиях только во время апдейта А когда

он обновился до конца он у нас только

вот в конкретной версии Почему так мы

затянули очевидно Вы видите что 1 19

вышел один двадцать выходит через

недели а мы все еще 16 но у нас уже

написан код который нам позволит 16 на

119 массово на Живую мы уверены что это

получится без простой обновить

И на самом деле он на следующей неделе

едет у нас на большую на большую

половину мастеров но мы что касается

переключения версии Куба у нас по сути в

классе есть одна единственная циферка

1.15 1.16 или 1.19 И когда в классе эту

цифру меняешь сам аккуратненько

аккуратненько аккуратненько переезжает

только при переезде с 1 15

нам приходит

и поочередно нужно проработать ноды

значит как мы

технически это делаем Ну то есть Давайте

выводы из этой штуки патч релиза точно

можно катать автоматом все классно

катается после версии 1.16 до версии

1.22 мы думаем что можно катать вообще

все автоматом и

Нет там никаких проблем

у нас есть экспериментально у нас есть

на тестовом стенде доказаны эти вещи

через месяц у нас это будет Доказано на

там 150 страх потому что я думаю что мы

массово переедем на 19 на лету Я думаю

что дальше мы поедем также на лету на 12

на

12122 скорее всего это будет опять

тяжелый апдейт потому что нужно будет

править манифест

по тому как у нас устроен наш софт

который вот это все обновление делает Я

к сожалению сегодня расскажу потому что

и так уже говорю больше часа

но есть другой доклад который нигде не

опубликован единственный способ его

найти это вот зайти по этой ссылке или

можно открыть опять-таки

flant.ru/8s и там нажать подробнее там

видос встроен Ну то есть неохота вот эта

ссылка перебивать с

youtube-land.ru/mk 8S и там внизу видео

найдете на Видное поставок развернуть

у меня все конечно же я не ответил на

вопрос как обновить cubernetis потому

что мне кажется ответ на этот вопрос

очень простой взять обновить но я думаю

что я показал как это штука устроена с

разных сторон Какие там внутренние

проблемы какие подводные камни Чего

ждать и как вообще это проделать

Напоминаю что мы торгуем менедж

кластерами Куба мы можем сделать или в

вашей инфре или в Облаке можем это

делать или вашими руками или нашими

руками sla очень дешево Классно Спасибо

за внимание Меня зовут Дима сталеров Я

технический директор фланта Спасибо тебе

большое доклад

вопросы давайте мы ждем пусть Дима еще

ответить на вопросы если они есть хотя

да у нас прям ты такой содержательный

доклад выдал Ну я понял что раз я

последний имеешь право Я полностью с

тобой согласен потому что Тем более люди

я вижу не уходят всем очень интересно

поэтому почему бы нет пусть наслаждаются

по вопросам Правда что-то пока вижу не

особо спешат и так понимаю в процессе

отвечал на какие-то правильно я наверное

могу пройтись по чатику и ответить

потому что я

буду не том порядке про

екс а как обновлять менеджер кубы

например

да как там встроенная штука ну в икс

надо понимать что Икс это не менедж кубы

это менеджт Control plain то есть

API сервер контроллер менеджер А вот все

остальное обновлять все равно вам но

если вы пользуетесь инструкцией

создаете штуки

короче делать как по инструкции

там надо просто Image обновить будет для

нот уже когда надо начнете

нажимаете кнопку

обновить

контроль на новую версию

он сам амазоном обновляется и дальше

ноды ноды в случае Икс только с

перекатом То есть даже если у Вас

если вы хотите минорный апдейку билета

то есть надо только с перекатом

вот приходить к нам обновляем ноты без

переката и все классно обновляется

[музыка]

ПО кнопочки изменение версии мастер

форме все верно но только

если я вру Скажите но по-моему

я на 90

N процентов уверен

[музыка]

там ссылочка про мамочку бы да короче

заходить прям реально

[музыка]

мы очень круто отдадим кластерам

На какие параметры в мониторинге вы

ориентируетесь

слушайте но это очень сложный ответ на

который

короткого ответа Просто быть не может и

я сейчас здесь на час останусь но все

сводится к наверное трем источникам

данных первое мы сами приложения

клиентов которые запущены в кубе

мониторим внешним видосом Ну короче у

нас есть

дистрибьютор сетка узлов мониторинга

которые активно типа раз в секунду раз

несколько секунд запросы из разных мест

у нас есть очень навороченная стата

потому как приложение отвечает снаружи

это один источник данных внешне

мониторинг второй источник данных это

Прометей Ну понятно что внутри кластером

очень много чего собираем

и на основании там этих вещей можно

понять третий источник данных это мы

сейчас пришли к тому что мы пишем смог

тесты и у нас в класть страх запущен

Smoke Test который

выполняет некоторые операции например

для того чтобы проверить что контроллер

менеджер работает нужно создать

дипломинты удостовериться что появился

пот не важно соски филосован или что он

просто появился соответственно которая

постоянно создает создает удаляет

создает удаляет создает удаляет диплоинд

и чекает что поды появляются то же самое

там доски джульетра нужно создать пот и

удостовериться что под прописалась Ну и

так далее по всем другим компонентам мы

гоняем Смоки соответственно вот три вещи

Кстати когда мы говорим про менедж куб у

нас то это не самый чистый куб у нас там

еще и Прометей и много чего

навороченного поверхности соответственно

к этому мы точно также подходим чем

плохо

да

всё с ним хорошо

кроме того что по факту он только в

амазоне нормально работает

в GP договорился не в игре

создавать короче

не работает на железе не работает в

ажуре не работает Не работает в сфере не

позволяет наживую обновлять ноды и кучу

кучу кучу таких ограничений

соответственно Мы в итоге написали свой

коктейль который кстати скоро опенсор с

ним об этом будет наверное громко

сказано называться будет декхаус от

слова рубка

[музыка]

так Дим там вопрос не вопрос А линкс со

слайда не работает почему-то на видео

которые ты присылал

сейчас прислали верные уже Вот ребята

поправили кто-то видим возможно

неправильно что-то сделала Хорошо давай

еще вопросы есть да да По каким метрикам

определяете что требуется для обновления

ответ на этот вопрос есть в том докладе

в линке Но если кратко у нас когда софт

новый выкатился у нас короче на каждой

но не стоит Димончик который обновляет

ноду

идем ночью обновляет Он выполняет код

обновления Баш и у нас там больше есть

конструкция типа проверить например

версию ядра если версия ядра не так надо

обновить ядро то у нас кот говорит

запросить в этот момент он дальше не

идет пока ему дадут

Он проставляет специально народу и у нас

при говорят о том что хей но до ожидает

disruption плюс еще есть режим

управления disruption Можно разрешить

автопруф тогда ноды по одной рубятся и

просто по одной сами денется автоматом

чарты Hyundai Hill 3 проверяйте

приобретика 8S я отвечал да

проверяем только не чарта релиза

социальных слов новые релиза лежащие в

на три Куба

знаю вас есть полезное посольство

утилиты планировать или написать ползут

для проверки версия 5 текущих манифестов

перед обновлением

написали там на самом-то деле Ну как бы

текущих манифестов так если мы говорим

про файлики То таких куча если мы

говорим про кластер мы чет ничего готовы

не нашли они мы нашли готовы завязали

работала медленно в итоге мы написали

каких-то костылях короче нет По крайней

мере 16 уже наверное не актуально для

122 может быть что-то сделаем

то есть Следующий вопрос то есть при

обновлении на 16 наиболее безопасность

минимальными построенным сделать новые

кластер постепенно приложение

50 на 50 Если вы в один 16 Обновите

Control Plane и не будете трогать ноды

никто этого не заметит никакой проблемы

нету при дипломе у вас может все упасть

с ошибкой там короче не поддерживаемый

при этом Вы можете быстро пойти и выпи

сервере Включить эту опеку то есть

Несмотря на то что они в один 16

отключены Их можно еще включить обратно

11 уже нет в 116 еще можно обратно

включить вы включаете и у Вас девелоперы

могут дальше дальше диплоить при этом вы

уже знаете где там ошибка Вы исправляете

и потом обратно отключаете ну и так вот

постепенно включение выключение

выключение можно добиться того чтобы

проблем не было по обновлению нот ну с

моей точки зрения при старте поочередно

ноды

проще чем разворачивать новый кластер

нужно новые мощности

я бы сказал что на 116 все равно лучше

[музыка]

там коммент по поводу обновления гкн от

пулы Но короче группу узлов

соответственно тоже обновляются по

кнопке но отдельно от мастера Да причем

с перекатом

там ссылочка на то как часто проверять

какая-то Тула Линк на видео

закончились до вопросы Я сейчас быстро

отвечу Дмитрий Сколько человек часов

необходимо для получения такого

обширного опыта

много у нас сейчас команда из 10 человек

на Full Time занимается чисто чисто этим

10 включая меня я много



